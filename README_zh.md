# LLM 驱动的动态视觉小说引擎

[English Version](./README.md)

---

> 一个用于创建动态、AI 生成的视觉小说和 Galgame 的框架，其故事、选项和角色反应均由大型语言模型驱动。

![ai-galgame-01.png](https://imgtu.com/upload/xzslo1tx/ai-galgame-01)

本项目使用 React、TypeScript 和 Dify.ai 后端，旨在创造一种沉浸式的、由叙事驱动的体验。它具有经典的视觉小说界面和一个健壮的与 LLM 的通信协议，以确保结构化和可靠的故事生成。

## ✨ 主要特性

-   **动态叙事**：故事由 LLM 根据玩家的选择和持续的游戏状态实时生成。
-   **有状态的角色**：角色拥有好感度，会根据玩家的行为而改变，从而影响她们的对话和反应。
-   **经典用户界面**：一个熟悉的视觉小说界面，以对话框和居中选项为特色。
-   **智能滚动**：对话框会随新文本自动滚动，但会尊重用户的操作，当用户手动向上滚动时，将停止自动滚动。
-   **健壮的 AI 通信**：使用清晰的 XML 标签格式（`<dialogue>` 和 `<command>`）来确保 LLM 以结构化和可预测的方式提供数据，防止格式损坏。
-   **可配置的故事**：定义你自己的世界、角色和开场，以创造一个独特的故事。

## 🛠️ 技术栈

-   **前端框架**: React 19
-   **构建工具**: Vite
-   **编程语言**: TypeScript
-   **UI**: Styled-components & Ant Design (用于加载和提示组件)
-   **状态管理**: Zustand
-   **样式方案**: Sass
-   **后端服务**: [Dify.ai](https://dify.ai/) (云服务或自托管)

## 📖 工作原理

本应用在一个结构化的“提示-响应”模型上运行：

1.  **前端**：管理 UI、游戏状态（好感度、剧情标记）和用户定义的 **故事背景**。
2.  **API 调用**：在每一轮，前端将玩家选择的动作和当前的游戏状态发送到 Dify API。
3.  **Dify 后端**：包含一个 Prompt，该 Prompt 定义了 AI 作为视觉小说导演的角色。它接收用户的动作和游戏状态以生成下一个场景。
4.  **响应格式**：LLM 返回一个用 XML 标签包裹的响应。`<dialogue>` 标签包含角色的语音，而 `<command>` 标签包含一个带有游戏指令的 JSON 对象（例如，更换背景、更新好感度、提供新选项）。
5.  **解析**：前端稳健地解析此响应，通过 Zustand 更新游戏状态，并渲染新场景。

## 🚀 快速上手

### 环境要求

-   Node.js (v18 或更高版本)
-   pnpm (或 npm/yarn)

### 安装与设置

1.  **克隆仓库并安装依赖：**
    ```sh
    git clone <repository_url>
    cd ai-galgame
    pnpm install
    ```

2.  **设置环境变量：**
    通过复制 `.env.example` 创建一个 `.env` 文件，并填入您的 Dify API URL 和应用密钥。
    ```
    VITE_API_URL=https://your-dify-api-url/v1
    VITE_API_KEY=app-your-dify-app-key
    ```

3.  **配置 Dify 工作流 (关键步骤)：**

    如果 Dify 后端配置不正确，本应用将无法工作。

    **第一步：添加变量**
    -   前往您的 Dify 应用并打开 **工作流 (Workflow)**。
    -   点击 **“开始”** 节点。
    -   在右侧面板的 **“应用变量 (Variables)”** 部分，点击 **“添加变量”**。
    -   将 **“Key”** 设置为 `creative_prompt` (必须完全一致)。
    -   将 **“类型 (Type)”** 设置为 `String`。

    **第二步：设置 Prompt**
    -   点击工作流中的 **“LLM”** 节点。
    -   复制本项目中 `DIFY_PROMPT_TEMPLATE.md` 文件的全部内容。
    -   将其粘贴到 LLM 节点的 **“Prompt”** 字段中，替换掉任何现有内容。

    **第三步：发布**
    -   点击右上角的 **“发布”** 按钮以保存并应用您的更改。

4.  **运行开发服务器：**
    ```sh
    pnpm run dev
    ```

## 🗺️ 开发路线图

本项目正处于活跃开发阶段。以下是计划中的功能和改进摘要：

-   **第一阶段：核心游戏循环**
    -   [x] 实现基本的文字冒险引擎。
    -   [x] 重构为 Galgame 风格的 UI（对话框、居中选项）。
    -   [x] 实现健壮的基于 XML 的解析。
    -   [x] 实现好感度和剧情标记的状态管理。
    -   [x] 实现智能对话滚动。

-   **第二阶段：富媒体与交互性**
    -   [ ] **角色立绘**：增加根据 LLM 指令在屏幕上显示角色立绘的支持。
    -   [ ] **游戏背景**：实现动态背景更换。
    -   [ ] **游戏音频**：集成 BGM 和音效管理器。
    -   [ ] **AI 生成资产**：探索集成图像生成 API 以动态创建立绘和背景。

-   **第三阶段：体验优化**
    -   [ ] **存档/读档系统**。
    -   [ ] **对话历史（Backlog）**。
    -   [ ] **角色资料界面**。